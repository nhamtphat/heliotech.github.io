---
title: 'XÃ¢y dá»±ng chatbox vá»›i Laravel Livewire pháº§n 2'
date: 2021-10-19T02:00:00Z
lastmod: '2021-10-19'
tags: ['laravel', 'guide', 'livewire', 'pusher']
draft: false
summary: 'XÃ¢y dá»±ng má»™t á»©ng dá»¥ng chat thá»i gian thá»±c (realtime chat box) Ä‘Æ¡n giáº£n vá»›i Livewire vÃ  Pusher pháº§n tiáº¿p theo'
layout: PostSimple
---

## Má»¥c lá»¥c

<TOCInline toc={props.toc} exclude="Má»¥c lá»¥c" toHeading={3} />

## Giá»›i thiá»‡u

Trong pháº§n trÆ°á»›c chÃºng ta Ä‘Ã£ lÃ m quen vá»›i Livewire vÃ  cÅ©ng biáº¿t cÃ¡ch nÃ³ táº¡o ra tÆ°Æ¡ng tÃ¡c gia front-end vÃ  back-end nhÆ° tháº¿ nÃ o, trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ giá»›i thiá»‡u Ä‘áº¿n cÃ¡c báº¡n cÃ¡ch sá»­ dá»¥ng Broadcasting trong Laravel vÃ  Pusher - má»™t dá»‹ch vá»¥ socket miá»…n phÃ­ mÃ  báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng cho cÃ¡c dá»± Ã¡n cá»§a mÃ¬nh Ä‘á»ƒ thá»±c hiá»‡n gá»­i thÃ´ng bÃ¡o realtime Ä‘áº¿n cÃ¡c client hiá»‡n táº¡i:

Äá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c hÆ°á»›ng dáº«n dÆ°á»›i Ä‘Ã¢y, báº¡n pháº£i thá»±c hiá»‡n hoÃ n táº¥t nhá»¯ng gÃ¬ á»Ÿ [Pháº§n 1 - CÃ i Ä‘áº·t livewire vÃ  táº¡o cÃ¡c model](https://heliotech.me/blog/chatbox-with-livewire-and-pusher-p1).

## CÃ i Ä‘áº·t Broadcasting Ä‘á»ƒ gá»­i Ä‘i sá»± kiá»‡n

Äá»ƒ Laravel cÃ³ thá»ƒ phÃ¡t Ä‘i cÃ¡c sá»± kiá»‡n Ä‘áº¿n ngÆ°á»i dÃ¹ng khÃ¡c (broadcasting) thÃ¬ báº¡n cáº§n Ä‘Äƒng kÃ½ service cá»§a nÃ³ bÃªn trong `config/app.php` báº¡n hÃ£y vÃ o file nÃ y vÃ  bá» `//` Ä‘áº§u dÃ²ng Ä‘i (uncomment)

```php
// App\Providers\BroadcastServiceProvider::class,
ğŸ‘‡
App\Providers\BroadcastServiceProvider::class,
```

Sau Ä‘Ã³, báº¡n cáº§n thay Ä‘á»•i `BROADCAST_DRIVER` máº·c Ä‘á»‹nh trong `.env` thÃ nh `pusher`

```dotenv {} showLineNumbers
BROADCAST_DRIVER=pusher
```

Tuy ráº±ng Laravel Ä‘Ã£ há»— trá»£ sáºµn cÃ¡c cáº¥u hÃ¬nh cho Pusher, tuy nhiÃªn ta váº«n cáº§n cÃ i Ä‘áº·t Pusher SDK cho dá»± Ã¡n cá»§a mÃ¬nh, hÃ£y cháº¡y lá»‡nh sau:

```bash
$ composer require pusher/pusher-php-server
```

## Cáº¥u hÃ¬nh Pusher

TrÆ°á»›c khi cáº¥u hÃ¬nh Pusher, báº¡n hÃ£y táº¡ má»™t tÃ i khoáº£n miá»…n phÃ­ táº¡i [https://dashboard.pusher.com/accounts/sign_up](https://dashboard.pusher.com/accounts/sign_up) sau Ä‘Ã³ Ä‘Äƒng nháº­p vÃ o báº£ng Ä‘iá»u khiá»ƒn.

Sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng, báº¡n hÃ£y áº¥n vÃ o **Channel** vÃ  táº¡o má»™t **App** má»›i (gÃ³i sandbox miá»…n phÃ­). Báº¡n chá»‰ cáº§n Ä‘áº·t tÃªn cho á»©ng dá»¥ng vÃ  cáº¥u hÃ¬nh mÃ¡y chá»§ sá»­ dá»¥ng (nÃªn chá»n Singapore)

- Front-end engine: Laravel Echo
- Back-end engine: Laravel

Sau khi táº¡o thÃ nh cÃ´ng, báº¡n sáº½ cÃ³ Ä‘Æ°á»£c cÃ¡c thÃ´ng tin bao gá»“m APP_ID, APP_Key, ... HÃ£y sao chÃ©p nÃ³ vÃ o bÃªn trong file `.env` cá»§a báº¡n:

```dotenv {} showLineNumbers
PUSHER_APP_ID=12839xx
PUSHER_APP_KEY=2dfa7dcc3c2b509axxxx
PUSHER_APP_SECRET=04c798031ade6381xxxx
PUSHER_APP_CLUSTER=ap1
```

## Táº¡o sá»± kiá»‡n gá»­i tin nháº¯n

Äá»ƒ thá»±c hiá»‡n gá»­i tin nháº¯n thá»i gian thá»±c, báº¡n cáº§n táº¡o ra má»™t sá»± kiá»‡n, vÃ­ dá»¥ á»Ÿ Ä‘Ã¢y lÃ  `SendMessage` má»—i khi má»™t tin nháº¯n gá»­i Ä‘áº¿n há»‡ thá»‘ng, nÃ³ sáº½ tá»± Ä‘á»™ng cháº¡y sá»± kiá»‡n nÃ y vÃ  thÃ´ng bÃ¡o cho cÃ¡c kÃªnh (channel) Ä‘áº£m nháº­n viá»‡c xá»­ lÃ½ nÃ³.

Äá»ƒ táº¡o má»™t Event trÃªn Larave ta dÃ¹ng lá»‡nh:

```bash
$ php artisan make:event MessageSent
```

Má»™t class sá»± kiá»‡n sáº½ Ä‘Æ°á»£c táº¡o ra bÃªn trong thÆ° má»¥c `app\Events` hÃ£y má»Ÿ thÆ° má»¥c nÃ y ra vÃ  báº¡n sáº½ tháº¥y file `MessageSent` báº¡n cáº§n thÃ´ng bÃ¡o cho Laravel biáº¿t ráº±ng sá»± kiá»‡n nÃ y sáº½ thá»±c hiá»‡n Broadcast báº±ng cÃ¡ch `implements ShouldBroadcast`

```php {8} showLineNumbers
<?php

namespace App\Events;

...
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;

class MessageSent implements ShouldBroadcast
{
		...
}
```

Ná»™i dung Ä‘áº§y Ä‘á»§ cá»§a Event nhÆ° sau:

```php {17-18,25-29,38} showLineNumbers
<?php

namespace App\Events;

use App\Models\Message;
use App\Models\User;
use Illuminate\Broadcasting\Channel;
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class MessageSent implements ShouldBroadcast
{
    use Dispatchable, InteractsWithSockets, SerializesModels;

    public $user;
    public $message;

    /**
     * Create a new event instance.
     *
     * @return void
     */
    public function __construct(User $user, Message $message)
    {
        $this->user = $user;
        $this->message = $message;
    }

    /**
     * Get the channels the event should broadcast on.
     *
     * @return \Illuminate\Broadcasting\Channel|array
     */
    public function broadcastOn()
    {
        return new Channel('chat');
    }
}
```

BÃ¢y giá» báº¡n cáº§n cho Laravel biáº¿t, khi nÃ o thÃ¬ sá»± kiá»‡n nÃ y diá»…n ra, hÃ£y má»Ÿ file `Chat.php` lÃªn vÃ  thÃªm vÃ o hÃ m `send`

```php {11} showLineNumbers
public function send()
{
    $user = Auth::user();

    $message = $user->messages()->create([
        'message' => $this->message
    ]);

    $this->reset();

    broadcast(new MessageSent($user, $message))->toOthers();
}
```

BÃ¢y giá» hÃ£y thá»­ Ä‘Äƒng nháº­p vÃ o Dashboard cá»§a Pusher vÃ  thá»±c hiá»‡n gá»­i tin nháº¯n thá»­. Náº¿u tin nháº¯n cá»§a báº¡n Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng Ä‘áº¿n Pusher, **Total messages sent today** cá»§a báº¡n sáº½ tÄƒng lÃªn:

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b968f62e-1913-404c-947a-c119e9178bb3/Untitled.png)

## Báº¯t sá»± kiá»‡n tin nháº¯n má»›i báº±ng Laravel Echo

Laravel Echo lÃ  má»™t thÆ° viá»‡n JS há»— trá»£ viá»‡c báº¯t sá»± kiá»‡n socket. Äá»ƒ cÃ i Ä‘áº·t Laravel Echo cÃ¡c báº¡n cáº§n cháº¡y lá»‡nh sau:

```bash
$ npm install --save laravel-echo pusher-js
```

Má»Ÿ file `resources/js/bootstrap.js` lÃªn vÃ  uncomment (bá» `//`) cáº¥u hÃ¬nh cho Echo:

```jsx {7-16} showLineNumbers
/**
 * Echo exposes an expressive API for subscribing to channels and listening
 * for events that are broadcast by Laravel. Echo and event broadcasting
 * allows your team to easily build robust real-time web applications.
 */

import Echo from 'laravel-echo'

window.Pusher = require('pusher-js')

window.Echo = new Echo({
  broadcaster: 'pusher',
  key: process.env.MIX_PUSHER_APP_KEY,
  cluster: process.env.MIX_PUSHER_APP_CLUSTER,
  forceTLS: true,
})
```

Thá»±c hiá»‡n láº¡i lá»‡nh build JS:

```jsx
$ npm run dev
```

ChÃ¨n JS Ä‘Ã£ Ä‘Æ°á»£c build vÃ o `views/layouts/app.blade.php`

```html {7} showLineNumbers
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <script src="{{ asset('js/app.js') }}" defer></script>

    <title>{{ config('app.name', 'Laravel') }}</title>

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap"
    />

    <!-- Styles -->
    @livewireStyles
  </head>
  <body class="font-sans antialiased">
    {{ $slot }} @livewireScripts
  </body>
</html>
```

Bá» `wire:poll` á»Ÿ view `resources/views/livewire/app.blade.php` Ä‘i nhÃ©:

```html {1} showLineNumbers
<div>
  @foreach($messages as $message)
  <div class="mb-1">{{ $message->user->name }}: {{ $message->message }}</div>
  @endforeach

  <form wire:submit.prevent="send">
    <input type="text" wire:model="message" />
    <button type="submit">Send</button>
  </form>
</div>
```

Cáº¥u hÃ¬nh sá»± kiá»‡n echo trong Livewire controller `app/Http/Livewire/App.php`

```php {15,37-40} showLineNumbers
<?php

namespace App\Http\Livewire;

use App\Events\MessageSent;
use App\Models\Message;
use Illuminate\Support\Facades\Auth;
use Livewire\Component;

class App extends Component
{
    public $message;
    public $messages;

    protected $listeners = ['echo:chat,MessageSent' => 'reloadMessages'];

    public function render()
    {
        $this->messages = Message::all();

        return view('livewire.app');
    }

    public function send()
    {
        $user = Auth::user();

        $message = $user->messages()->create([
            'message' => $this->message
        ]);

        $this->reset();

        broadcast(new MessageSent($user, $message))->toOthers();
    }

    public function reloadMessages($event)
    {
        $this->messages->concat($event['message']);
    }
}
```

NhÆ° báº¡n tháº¥y á»Ÿ Ä‘Ã¢y, khi nháº­n Ä‘Æ°á»£c sá»± kiá»‡n `MessageSent` tá»« kÃªnh `chat` Livewire sáº½ cáº§n thá»±c hiá»‡n hÃ m `reloadMessages`

Trong hÃ m `reloadMessages` mÃ¬nh sáº½ láº¥y tin nháº¯n vá»«a nháº­n Ä‘Æ°á»£c (trong `$event` cÃ³ hai pháº§n tá»­ lÃ  **user** vÃ  **message** mÃ¬nh chá»‰ cáº§n **message**) vÃ  thÃªm nÃ³ vÃ o máº£ng `$this->massages` cá»§a component.

Khi dá»¯ liá»‡u cá»§a component Ä‘Æ°á»£c cáº­p nhÃ¢t, view cÅ©ng sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c reload láº¡i mÃ  khÃ´ng cáº§n `wire:poll` ná»¯a

Náº¿u báº¡n cÃ³ tháº¯c máº¯c gÃ¬ trong quÃ¡ trÃ¬nh lÃ m, Ä‘á»«ng ngáº¡i comment bÃªn dÆ°á»›i Ä‘á»ƒ mÃ¬nh há»— trá»£ nhÃ©.

<BlogNewsletterForm />
