---
title: 'Giáº£i quyáº¿t váº¥n Ä‘á» N+1 trong quan há»‡ cha - con vÃ´ táº­n'
date: 2021-10-12T00:00:00Z
lastmod: '2021-10-12'
tags: ['laravel', 'guide']
draft: false
summary: 'Máº¹o sá»­ dá»¥ng Eager Loading Ä‘á»ƒ giáº£i quyáº¿t nhá»¯ng trÆ°á»ng há»£p N+1 query khi á»©ng dá»¥ng cÃ³ quan há»‡ cha - con vÃ´ táº­n nhÆ° thÆ° má»¥c, cÃ¢y hay tÆ°Æ¡ng tá»±.'
layout: PostSimple
---

## Má»¥c lá»¥c

<TOCInline toc={props.toc} exclude="Má»¥c lá»¥c" toHeading={3} />

## Äáº·t váº¥n Ä‘á»

Trong khi phÃ¡t triá»ƒn á»©ng dá»¥ng, cháº¯c háº³n cÃ¡c báº¡n Ä‘Ã£ gáº·p pháº£i trÆ°á»ng há»£p Ä‘á»‡ quy cha-con trong khi phÃ¡t triá»ƒn cÃ¡c dá»± Ã¡n, vÃ­ dá»¥ nhÆ° cÃ¢y thÆ° má»¥c nhÆ° sau:

| id  | name | parent_id |
| --- | ---- | --------- |
| 1   | A    | null      |
| 2   | B    | 1         |
| 3   | C    | 1         |
| ... | ...  | ...       |

Trong bÃ i viáº¿t nÃ y mÃ¬nh sáº½ láº¥y vÃ­ dá»¥ vá» `QuestionFolder`, thÆ° cÃ¢y thÆ° má»¥c chá»©a cÃ¢u há»i cá»§a há»‡ thá»‘ng tráº¯c nghiá»‡m.
ThÃ´ng thÆ°á»ng chÃºng ta sáº½ táº¡o 2 relationship á»Ÿ Model nhÆ° sau:

```php
// Model QuestionFolder.php
public function childs()
{
    return $this->hasMany('App\Models\QuestionFolder', 'parent_id', 'id');
}

public function parent()
{
    return $this->belongsTo('App\Models\QuestionFolder', 'parent_id', 'id');
}
```

Váº­y khi chÃºng ta cáº§n láº¥y ra `Collection` táº¥t cáº£ cÃ¡c thÆ° má»¥c con (vÃ  cáº£ thÆ° má»¥c con cá»§a thÆ° má»¥c con ná»¯a) cá»§a má»™t thÆ° má»¥c nÃ o Ä‘Ã³:

```php
// Model QuestionFolder.php
public function allChildFolders()
{
    $child_folders = [$this];
    $folders = [$this];
    while(count($folders) > 0) {
        $nextFolders = [];
        foreach ($folders as $folder) {
            $child_folders = array_merge($child_folders, $folder->childs->all());
            $nextFolders = array_merge($nextFolders, $folder->childs->all());
        }
        $folders = $nextFolders;
    }

    return new Collection($child_folders);
}
```

BÃ¢y giá» cháº¡y xem káº¿t quáº£ nÃ o:

```php
// Route web.php
Route::get('test-recursive', function() {
    dump(\App\Models\QuestionFolder::findOrFail(27)->all_child_folders);
});
```

<S3Image src="/posts/giai-quyet-van-de-n1-trong-quan-he-cha-con/1.webp" />

Má»i thá»© váº«n cá»© ok, báº¡n váº«n cÃ³ Ä‘Æ°á»£c káº¿t quáº£ mong muá»‘n. NhÆ°ng táº­n 101 lÆ°á»£t truy váº¥n, **quÃ¡ nhiá»u query**. Trong má»™t á»©ng dá»¥ng cÃ³ vÃ i chá»¥c thÆ° má»¥c thÃ¬ cÃ³ váº» á»•n, tuy nhiÃªn náº¿u sá»‘ lÆ°á»£ng thÆ° má»¥c lÃªn Ä‘áº¿n hÃ ng ngÃ n, hay chá»¥c ngÃ n, Laravel sáº½ pháº£i **truy váº¥n hÃ ng chá»¥c ngÃ n láº§n**, vÃ  CSDL cá»§a báº¡n sáº½ nhÆ° cÃ¡i má»m rÃ¡ch â˜¹

## Giáº£i quyáº¿t váº¥n Ä‘á» N+1 trong quan há»‡ cha con

Trong Laravel cÃ³ má»™t chá»©c nÄƒng ráº¥t tiá»‡n lá»£i Ä‘á»ƒ giáº£i quyáº¿t nhá»¯ng trÆ°á»ng há»£p N+1 query Ä‘Ã³ chÃ­nh lÃ  Eager Loading.

NhÆ°ng á»Ÿ trÆ°á»ng há»£p nÃ y, chÃºng ta khÃ´ng biáº¿t cÃ¢y thÆ° má»¥c nÃ y sÃ¢u bao nhiÃªu Ä‘á»ƒ cÃ³ thá»ƒ gá»i phÆ°Æ¡ng thá»©c `with()`.
VÃ¬ váº­y chÃºng ta sáº½ bá»• sung vÃ o má»™t quan há»‡ lÃ  `allChilds`:

```php
// Model Folder.php
public function allChilds()
{
    return $this->childs()->with('allChilds');
}
```

VÃ  sá»­a hÃ m `allChildFolders()` láº¡i má»™t xÃ­u:

```
public function allChildFolders()
{
    $child_folders = [$this];
    $folders = [$this];
    while(count($folders) > 0) {
        $nextFolders = [];
        foreach ($folders as $folder) {
            $child_folders = array_merge($child_folders, $folder->allChilds->all());
            $nextFolders = array_merge($nextFolders, $folder->allChilds->all());
        }
        $folders = $nextFolders;
    }

    return new Collection($child_folders);
}
```

Ta táº¡o thÃªm má»™t route khÃ¡c Ä‘á»ƒ test xem nÃ o

```php
// Route web.php
Route::get('test-recursive', function() {
    dump(\App\Models\QuestionFolder::findOrFail(27)->allChildFolders);
});
```

VÃ  Ä‘Ã¢y lÃ  káº¿t quáº£:

<S3Image src="/posts/giai-quyet-van-de-n1-trong-quan-he-cha-con/2.webp" />

BÃ i viáº¿t Ä‘Æ°á»£c Ä‘Äƒng táº£i trÃªn [Viblo](https://viblo.asia/p/giai-quyet-van-de-n1-trong-quan-he-cha-con-vo-tan-bang-eager-loading-vyDZOk8PZwj) trong sá»± kiá»‡n May Fest 2021, hy vá»ng lÃ  cÃ¡c báº¡n thÃ­ch bÃ i viáº¿t nÃ y, happy coding ğŸ¥°

<BlogNewsletterForm title="Náº¿u báº¡n thÃ­ch nhá»¯ng bÃ i tháº¿ nÃ y?" />
