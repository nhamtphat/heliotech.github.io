---
title: 'Giáº£i quyáº¿t váº¥n Ä‘á» bá»™ nhá»› khi sá»­ dá»¥ng Eager Loading'
date: 2021-10-12T00:00:00Z
lastmod: '2021-10-12'
tags: ['laravel', 'guide']
draft: false
summary: 'Eager Loading cÃ³ thá»ƒ nhanh vÃ  giáº£m ráº¥t nhiá»u query khÃ´ng cáº§n thiáº¿t, tuy nhiÃªn á»Ÿ má»™t sá»‘ trÆ°á»ng há»£p nÃ³ sáº½ lÃ m trÃ n bá»™ nhá»›.'
layout: PostSimple
---

## Má»¥c lá»¥c

<TOCInline toc={props.toc} exclude="Má»¥c lá»¥c" toHeading={3} />

## Váº¥n Ä‘á» bá»™ nhá»› khi sá»­ dá»¥ng Eager Loading

HÃ´m nay chÃºng ta sáº½ Ä‘Æ°a Ä‘áº¿n má»™t váº¥n Ä‘á» khÃ´ng pháº£i má»›i, vÃ  cháº¯c lÃ  cÃ¡c báº¡n cÅ©ng Ä‘Ã£ tá»«ng giáº£i quyáº¿t rá»“i, Ä‘Ã³ chÃ­nh lÃ  **láº¥y má»™t Ä‘á»‘i tÆ°á»£ng tá»« quan há»‡ `hasMany`**, vÃ­ dá»¥ ta cÃ³ 2 Ä‘á»‘i tÆ°á»£ng lÃ  `Post` vÃ  `Comment` nhÆ° sau Ä‘Ã¢y:

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/2.webp" />

Giáº£ sá»­ báº¡n sáº½ cáº§n láº¥y ra má»™t danh sÃ¡ch bÃ i viáº¿t vÃ  má»™t bÃ¬nh luáº­n má»›i nháº¥t tá»«ng bÃ i viáº¿t Ä‘Ã³, báº¡n sáº½ lÃ m tháº¿ nÃ o?

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/3.webp" />

ChÃºng ta cÃ³ ráº¥t nhiá»u cÃ¡ch Ä‘á»ƒ thá»±c hiá»‡n Ä‘á» bÃ i nÃ y

1. Thá»±c hiá»‡n bÃ¬nh thÆ°á»ng báº±ng Laravel relationship
2. Thá»±c hiá»‡n báº±ng Laravel relationship & Eager loading
3. Thá»±c hiá»‡n báº±ng Dynamic relationship & Eager loading

HÃ£y cÃ¹ng nhau tÃ¬m hiá»ƒu qua tá»«ng cÃ¡ch lÃ m cÅ©ng nhÆ° Æ°u vÃ  khuyáº¿t Ä‘iá»ƒm cá»§a má»—i cÃ¡ch tiáº¿p cáº­n nhÃ©

## Sá»­ dá»¥ng Laravel relationship

Trong Laravel báº¡n dá»… dÃ ng thá»±c hiá»‡n Ä‘Æ°á»£c viá»‡c nÃ y thÃ´ng qua model `Post` vÃ  quan há»‡ `comments`, mÃ¬nh bá» qua bÆ°á»›c táº¡o project nhÃ©, ta Ä‘i tiáº¿p vÃ o vÃ­ dá»¥ dÆ°á»›i Ä‘Ã¢y:

```php
// Trong class Post.php ta cÃ³:
public function comments()
{
  return $this->hasMany('App\Models\Comment');
}
```

VÃ  trong controller ta chá»‰ cáº§n gá»i `all()` vÃ  truyá»n dá»¯ liá»‡u qua view:

```php
$posts = Post::all();
return view('list', compact('posts'));
```

Trong view sáº½ cÃ³ 2 cá»™t, **tÃªn bÃ i viáº¿t** vÃ  **bÃ¬nh luáº­n má»›i nháº¥t**:

```html
<table>
  <thead>
    <tr>
      <th>BÃ i viáº¿t</th>
      <th>BÃ¬nh luáº­n</th>
    </tr>
  </thead>
  <tbody>
    @foreach($posts as $post)
    <tr>
      <td>{{ $post->title }}</td>
      <td>{{ $post->comments->sortByDesc('created_at')->first()->content }}</td>
    </tr>
    @endforeach
  </tbody>
</table>
```

Káº¿t quáº£:

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/4.webp" />

12 láº§n truy váº¥n CSDL trong má»™t láº§n, Ä‘á»‘i vá»›i vÃ­ dá»¥ nÃ y, sá»‘ lÆ°á»£ng khÃ´ng pháº£i lÃ  quÃ¡ nhiá»u, tuy nhiÃªn vá»›i má»™t sá»‘ lÆ°á»£ng lá»›p DB Ä‘áº¿n vÃ i ngÃ n bÃ i viáº¿t thÃ¬ cÃ³ váº» sáº½ ráº¥t tá»‡.

## Sá»­ dá»¥ng relationship vÃ  Eager loading

NhÆ° Ä‘Ã£ nÃ³i á»Ÿ [bÃ i viáº¿t trÆ°á»›c](https://viblo.asia/p/giai-quyet-van-de-n1-trong-quan-he-cha-con-vo-tan-bang-eager-loading-vyDZOk8PZwj), váº¥n Ä‘á» truy váº¥n cá»§a Laravel cÃ³ thá»ƒ dá»… dÃ ng giáº£i quyáº¿t báº±ng Eager loading. Ta sáº½ táº¡o cÃ¡c relationship trong cÃ¡c model Post nhÆ° sau:

```php
// HasMany
public function comments()
{
  return $this->hasMany('App\Models\Comment');
}
```

Controller:

```php
$posts = Post::with('comments')->get();
```

View:

```html
<table>
  <thead>
    <tr>
      <th>BÃ i viáº¿t</th>
      <th>BÃ¬nh luáº­n</th>
    </tr>
  </thead>
  <tbody>
    @foreach($posts as $post)
    <tr>
      <td>{{ $post->title }}</td>
      <td>{{ $post->comments->sortByDesc('created_at')->first()->content }}</td>
    </tr>
    @endforeach
  </tbody>
</table>
```

Káº¿t quáº£:

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/5.webp" />

## Váº«n lÃ  Eager Loading, nhÆ°ng lÃ  `hasOne`

NhÆ° báº¡n tháº¥y, chÃºng ta Ä‘Ã£ giáº£m lÆ°á»£ng truy váº¥n xuá»‘ng cÃ²n 2 truy váº¥n, báº¡n cÅ©ng cÃ³ thá»ƒ tá»‘i Æ°u cho code Ä‘áº¹p hÆ¡n báº±ng cÃ¡ch táº¡o quan há»‡ `hasOne` giá»¯a 2 Ä‘á»‘i tÆ°á»£ng.

```php
// HasOne
public function latest_comment()
{
  return $this->hasOne('App\Models\Comment')->latest();
}
```

Controller:

```php
$posts = Post::with('latest_comment')->get();
```

View:

```html
<table>
  <thead>
    <tr>
      <th>BÃ i viáº¿t</th>
      <th>BÃ¬nh luáº­n</th>
    </tr>
  </thead>
  <tbody>
    @foreach($posts as $post)
    <tr>
      <td>{{ $post->title }}</td>
      <td>{{ $post->latest_comment->content }}</td>
    </tr>
    @endforeach
  </tbody>
</table>
```

Káº¿t quáº£:

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/6.webp" />

Hola! code Ä‘Ã£ Ä‘áº¹p vÃ  ráº¥t dá»… Ä‘á»c. Tuy nhiÃªn (láº¡i tuy nhiÃªn) náº¿u báº¡n Ä‘á»ƒ Ã½ tháº¥y ta chá»‰ cáº§n dÃ¹ng 20 model (10 post vÃ  10 comment má»›i nháº¥t) nhÆ°ng á»Ÿ Ä‘Ã¢y láº¡i load Ä‘áº¿n 10010 model, tá»©c lÃ  nÃ³ sáº½ láº¥y ra 10 bÃ i viáº¿t vÃ  **táº¥t cáº£ bÃ¬nh luáº­n** cá»§a 10 bÃ i viáº¿t Ä‘Ã³ ğŸ˜±ğŸ˜± Náº¿u báº¡n cÃ³ má»™t mÃ¡y chá»§ khÃ´ng giá»›i háº¡n dung lÆ°á»£ng, viá»‡c nÃ y khÃ´ng sao, tuy nhiÃªn nÃ³ sáº½ lÃ m giáº£m Ä‘Ã¡ng ká»ƒ kháº£ nÄƒng xá»­ lÃ½ vÃ  cÃ³ váº» khÃ´ng á»•n, HÃ£y luÃ´n ghi nhá»›:

> Database queries first, memory usage second

## Giáº£i quyáº¿t báº±ng Dynamic relationship

Trong vÃ­ dá»¥ trÃªn, ta Ä‘Ã£ thÃ nh cÃ´ng trong viá»‡c giáº£m thiá»ƒu tá»‘i Ä‘a cÃ¡c truy váº¥n khÃ´ng cáº§n thiáº¿t nhÆ°ng vÃ´ tÃ¬nh Ä‘Ã£ lÃ m tÄƒng dung lÆ°á»£ng ram. HÃ£y luÃ´n nhá»› "Database queries first, memory usage second"
Viá»‡c nÃ y cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng cÃ¡ch thá»±c hiá»‡n má»™t [Subquery Select](https://laravel.com/docs/8.x/eloquent#subquery-selects) vÃ  táº¡o má»™t relationship `belongsTo` cho `Post`

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/7.webp" />

NhÃ¬n vÃ o hÃ¬nh á»Ÿ trÃªn cho dá»… hiá»ƒu, khi thá»±c hiá»‡n truy váº¥n, ta sáº½ thÃªm vÃ o má»™t cá»™t tÃªn lÃ  `latest_comment_id`, cá»™t nÃ y Ä‘Æ°á»£c láº¥y tá»« báº£ng `comments` vá»›i cÃ¡c Ä‘iá»u kiá»‡n Ä‘áº·t trÆ°á»›c.

```php
// Relationship
public function latest_comment()
{
    return $this->belongsTo('App\Models\Comment', 'latest_comment_id', 'id');
}
// Subquery
public function scopeWithLatestComment($query)
{
    $query->addSelect([
        'latest_comment_id' => Comment::select('id')
            ->whereColumn('post_id', 'posts.id')
            ->orderBy('created_at', 'desc')
            ->take(1)
    ])->with('latest_comment');
}
```

Controller:

```php
$posts = Post::withLatestComment()->get();
```

View:

```html
<table>
  <thead>
    <tr>
      <th>BÃ i viáº¿t</th>
      <th>BÃ¬nh luáº­n</th>
    </tr>
  </thead>
  <tbody>
    @foreach($posts as $post)
    <tr>
      <td>{{ $post->title }}</td>
      <td>{{ $post->latest_comment->content }}</td>
    </tr>
    @endforeach
  </tbody>
</table>
```

Káº¿t quáº£:

<S3Image src="/posts/giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading/8.webp" />

Bingo! káº¿t quáº£ chá»‰ cÃ³ 2 truy váº¥n, vÃ  20 model Ä‘Æ°á»£c táº£i lÃªn á»©ng dá»¥ng, bá»™ nhá»› sá»­ dá»¥ng Ä‘Ã£ giáº£m tá»« 33mb ~ 18mb. Váº­y lÃ  vá»«a Ä‘áº£m báº£o Ä‘Æ°á»£c 2 tiÃªu chÃ­ Ä‘áº·t ra. Náº¿u tháº¥y bÃ i viáº¿t nÃ y há»¯u Ã­t Ä‘á»«ng ngáº¡i chia sáº» cho báº¡n bÃ¨ mÃ¬nh nhÃ©. Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘á»c â™¥

BÃ i viáº¿t Ä‘Æ°á»£c Ä‘Äƒng táº£i trÃªn [Viblo](https://viblo.asia/p/laravel-giai-quyet-van-de-bo-nho-khi-su-dung-eager-loading-3Q75wV2GlWb) trong sá»± kiá»‡n May Fest 2021.

<BlogNewsletterForm title="Náº¿u báº¡n thÃ­ch nhá»¯ng bÃ i tháº¿ nÃ y?" />

Tham kháº£o:

- https://reinink.ca/articles/dynamic-relationships-in-laravel-using-subqueries
- https://laravel.com/docs/8.x/eloquent#subquery-selects
